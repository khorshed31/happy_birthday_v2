<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>🎉 Surprise Birthday!</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&family=Great+Vibes&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  :root{
    --bg:#0b0f1a; --wall:#0f1424; --wall-top:#131a2b; --floor:#0a0e18;
    --accent:#ff4d8d; --gold:#f9c642; --neon:#ffd3e6; --light:#ffe8a3;
    --glass-bg: rgba(255,255,255,.06); --glass-brd: rgba(255,255,255,.18);
    --text-grad: linear-gradient(90deg, #ff66a3, #ffd43b, #5eead4, #60a5fa, #ff66a3);
  }

  html, body { height:100%; }
  body{
    margin:0; color:#fff; overflow-x:hidden;
    font-family:'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: linear-gradient(180deg, var(--wall-top) 0 55%, var(--floor) 55% 100%);
  }
  body:before{
    content:""; position:fixed; inset:0; z-index:0; pointer-events:none;
    background: radial-gradient(1200px 600px at 50% -10%, rgba(255,255,255,.06), rgba(0,0,0,.5) 60%, rgba(0,0,0,.8) 100%);
    mix-blend-mode:screen; opacity:.7;
  }
  body:after{
    content:""; position:fixed; left:0; right:0; top:55%; height:4px; z-index:0;
    background:linear-gradient(90deg, rgba(255,255,255,.18), rgba(255,255,255,.04), rgba(255,255,255,.18));
    filter:blur(.2px);
  }

  /* Scene & layers */
  .scene{ position:relative; min-height:100vh; display:flex; align-items:center; justify-content:center; text-align:center; padding:11rem 1rem 6rem; z-index:6; }

  .doors{ position:fixed; inset:0; z-index:80; pointer-events:auto; }
  body.open .doors{ pointer-events:none; }
  .door{ position:absolute; top:0; width:50%; height:100%;
    background: linear-gradient(135deg, rgba(0,0,0,.25), rgba(255,255,255,.05)), repeating-linear-gradient(180deg, #5b3a2a 0 10px, #4b2f24 10px 20px), radial-gradient(100% 100% at 50% 0%, #6e4734 0%, #2e1913 70%);
    box-shadow:inset 0 0 80px rgba(0,0,0,.65), 0 20px 60px rgba(0,0,0,.35); transition:transform 1.1s ease-in-out;
  }
  .door.left{ left:0; border-right:4px solid #3b2017; } .door.right{ right:0; border-left:4px solid #3b2017; }
  body.open .door.left{ transform:translateX(-100%); } body.open .door.right{ transform:translateX(100%); }
  .handle{ position:absolute; top:50%; width:18px; height:18px; border-radius:50%; background:radial-gradient(circle at 35% 35%, #fff6cc, #cda85a 60%, #926c28 100%); box-shadow:0 0 0 3px rgba(0,0,0,.35); }
  .door.left .handle{ right:18px; } .door.right .handle{ left:18px; }

  .door-button{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:140px; height:140px; border-radius:999px; cursor:pointer; z-index:85;
    background: radial-gradient(circle at 30% 30%, #fff8cc, #ffb703 55%, #b45309 100%);
    box-shadow:0 0 0 8px rgba(0,0,0,.25), 0 0 30px 6px rgba(255,197,61,.45), inset 0 8px 18px rgba(255,255,255,.45), inset 0 -8px 18px rgba(0,0,0,.35);
    display:flex; align-items:center; justify-content:center; transition: transform .2s ease, box-shadow .2s ease;
  }
  .door-button:hover{ transform:translate(-50%,-50%) scale(1.05); }
  .door-button:active{ transform:translate(-50%,-50%) scale(0.98); }
  .door-button span{ font-weight:800; letter-spacing:.5px; text-transform:uppercase; line-height:1.1; font-size:14px; color:#442c00; text-shadow:0 1px 0 rgba(255,255,255,.5); width:80%; text-align:center; }
  .door-label{ position:absolute; left:50%; top:calc(50% + 95px); transform:translateX(-50%); font-size:14px; opacity:.8; letter-spacing:.3px; }

  .dark-overlay{ position:fixed; inset:0; background:radial-gradient(circle at 50% -20%, rgba(255,255,255,0.06), rgba(0,0,0,0.92) 55%); transition:opacity .7s ease; z-index:1; pointer-events:none; }
  body.lights-on .dark-overlay{ opacity:0; }

  .bunting{ position:absolute; top:0; left:0; right:0; height:90px; opacity:0; transition:opacity 1s ease .2s; z-index:3; }
  .banner { position:absolute; top:70px; left:0; right:0; height:170px; opacity:0; transform:translateY(-8px); transition:opacity .9s ease .35s, transform .9s ease .35s; z-index:4; pointer-events:none; }
  .string-lights{ position:absolute; top:8px; left:0; right:0; height:120px; pointer-events:none; opacity:0; transition:opacity .9s ease .2s; z-index:5; }
  body.lights-on .bunting, body.lights-on .banner, body.lights-on .string-lights{ opacity:1; transform:none; }
  .banner text{ font: 800 58px/1 "Poppins", Arial, sans-serif; letter-spacing:3px; fill:url(#bannerGradient); stroke:#fff; stroke-width:1.5px; paint-order:stroke fill; filter: drop-shadow(0 2px 2px rgba(0,0,0,.4)) drop-shadow(0 0 14px rgba(255,77,141,.4)); }

  .balloons{ position:absolute; inset:0; pointer-events:none; overflow:hidden; opacity:0; transition:opacity 1s ease .3s; z-index:1; }
  body.lights-on .balloons{ opacity:1; }
  .balloon-wrap{ position:absolute; bottom:-25vh; width:90px; height:140px; filter:drop-shadow(0 10px 14px rgba(0,0,0,.35)); }
  .balloon-svg{ width:90px; height:120px; opacity:.9; }
  .balloon-string{ position:absolute; top:95px; left:45px; width:2px; height:120px; background:linear-gradient(#eee,#bbb); opacity:.85; }
  @keyframes floatUp{ 0%{ transform:translateY(0) translateX(0) rotate(0deg);} 100%{ transform:translateY(-135vh) translateX(var(--drift,0)) rotate(var(--twist,6deg)); } }

  .sparkles{ position:fixed; inset:0; pointer-events:none; z-index:2; }
  .sparkles span{ position:absolute; width:4px; height:4px; background:#fff; border-radius:50%; box-shadow:0 0 8px #fff, 0 0 14px var(--light); animation:sparkle 2.6s linear infinite; }
  @keyframes sparkle{ 0%{transform:translateY(0); opacity:0;} 10%{opacity:1;} 100%{transform:translateY(-40vh); opacity:0;} }

  .confetti{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index:7; }
  .confetti span{ position:absolute; width:10px; height:14px; opacity:0; }
  @keyframes fall{0%{opacity:1; transform:translateY(-100vh) rotate(0);}100%{opacity:1; transform:translateY(110vh) rotate(720deg);} }

  .table-surface{ width:min(820px, 95vw); height:44px; margin: 0 auto; border-radius:14px;
    background: linear-gradient(180deg,#8f5e3e,#6d422a 60%, #5a3521); box-shadow: 0 12px 28px rgba(0,0,0,.35), inset 0 2px 0 rgba(255,255,255,.25); z-index:0; }

  .cake-wrap{ opacity:0; transform:translateY(20px); transition:all .7s ease; z-index:6; }
  body.lights-on .cake-wrap{ opacity:1; transform:none; }
  .cake-svg{ display:block; margin:2rem auto 0; width:100%; max-width:560px; height:auto; }
  .candle-hit{ cursor:pointer; }
  .flame{ opacity:0; filter:drop-shadow(0 0 10px rgba(255,190,70,.85)); transition:opacity .25s ease; }
  .flame.flicker{ animation:flicker .12s infinite alternate ease-in-out; }
  @keyframes flicker{ from{transform:scaleY(1);} to{transform:scaleY(1.12) translateX(1px);} }

  .neon{ font-weight:800; letter-spacing:.5px; text-shadow:0 0 6px var(--neon), 0 0 14px var(--neon), 0 0 28px #ff4d8d; }
  .message-card{ margin:12px auto 0; padding:18px 22px; max-width:820px; background:var(--glass-bg); border:1px solid var(--glass-brd); border-radius:20px; backdrop-filter:blur(6px); box-shadow:0 10px 32px rgba(0,0,0,.25), inset 0 0 40px rgba(255,255,255,.05); z-index:6; position:relative; }
  #typeLine{ font-weight:800; font-size:clamp(1.6rem, 2.2vw + 1rem, 2.6rem); line-height:1.25; background:var(--text-grad); background-size:300% 300%; -webkit-background-clip:text; background-clip:text; color:transparent; animation:hueflow 9s ease-in-out infinite alternate; text-shadow:0 2px 0 rgba(0,0,0,.35); }
  @keyframes hueflow{ 0%{background-position:0% 50%;} 100%{background-position:100% 50%;} }

  .prompt{ margin-top:1rem; font-weight:600; }
  .controls{ gap:.5rem; }
  .hidden{ display:none !important; }
  .muted{ opacity:.75; }

  /* === Sticky guide bar === */
  .guide{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    z-index:90; max-width:92vw; padding:10px 14px; border-radius:999px;
    background:rgba(18,24,40,.78); border:1px solid rgba(255,255,255,.15);
    box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 24px rgba(255,255,255,.05);
    display:flex; align-items:center; gap:10px; backdrop-filter: blur(8px);
  }
  .guide .dot{ width:10px; height:10px; border-radius:50%; background:#60a5fa; box-shadow:0 0 10px #60a5fa; }
  .guide strong{ letter-spacing:.3px; }
  #guideText{ font-weight:600; }
  #liveGuide{ position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden; }

  /* Responsive tidy */
  @media (max-width: 992px){ .scene{ padding-top:9rem; } .banner{ top:56px; height:130px; } }
  @media (max-width: 768px){
    .scene{ padding-top:8rem; padding-bottom:3.5rem; }
    .bunting{ height:72px; } .string-lights{ height:90px; top:4px; }
    .banner{ top:62px; height:150px; } .banner text{ font:800 40px/1 "Poppins", Arial, sans-serif; letter-spacing:2px; }
    .table-surface{ height:38px; border-radius:12px; }
    .door-button{ width:108px; height:108px; }
    .balloon-wrap{ width:64px; height:100px; } .balloon-svg{ width:64px; height:86px; }
  }
  @media (max-width: 576px){
    .scene{ padding:6.5rem .75rem 3.75rem; } /* extra bottom for guide */
    .door-button{ width:88px; height:88px; } .door-label{ top:calc(50% + 72px); font-size:13px; }
    .banner, .bunting, .string-lights{ display:none; }
    .balloons, .confetti, .sparkles{ display:none !important; }
    .message-card{ padding:14px 16px; } .prompt{ margin-top:.6rem; }
  }
</style>
</head>
<body>
  <!-- Audio -->
  <audio id="music" src="birthday.mp3" preload="auto"></audio>

  <!-- Doors -->
  <div class="doors" id="doorsLayer" aria-label="Closed doors">
    <div class="door left"><span class="handle" style="top:55%;"></span></div>
    <div class="door right"><span class="handle" style="top:45%;"></span></div>
    <button id="btnDoorKnob" class="door-button d-flex align-items-center justify-content-center" aria-label="Press to enter">
      <span>Press to Enter</span>
    </button>
    <div class="door-label">Back from office… press to open</div>
  </div>

  <!-- Vignette -->
  <div class="dark-overlay" aria-hidden="true"></div>

  <!-- Bunting -->
  <svg class="bunting d-none d-sm-block" viewBox="0 0 1200 120" preserveAspectRatio="none" aria-hidden="true">
    <defs>
      <linearGradient id="tri1" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#ff99c2"/><stop offset="100%" stop-color="#ff4d8d"/></linearGradient>
      <linearGradient id="tri2" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#9bd0ff"/><stop offset="100%" stop-color="#4dabf7"/></linearGradient>
      <linearGradient id="tri3" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#b9f0bf"/><stop offset="100%" stop-color="#51cf66"/></linearGradient>
      <linearGradient id="tri4" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#ffe8a3"/><stop offset="100%" stop-color="#f9c642"/></linearGradient>
    </defs>
    <path d="M0,10 Q300,60 600,10 T1200,10" stroke="#fff" stroke-width="3" fill="none" opacity=".35"/>
    <g>
      <polygon points="40,20 10,110 70,110" fill="url(#tri1)"/>
      <polygon points="120,18 90,110 150,110" fill="url(#tri2)"/>
      <polygon points="200,22 170,110 230,110" fill="url(#tri3)"/>
      <polygon points="280,17 250,110 310,110" fill="url(#tri4)"/>
      <polygon points="360,23 330,110 390,110" fill="url(#tri1)"/>
      <polygon points="440,19 410,110 470,110" fill="url(#tri2)"/>
      <polygon points="520,21 490,110 550,110" fill="url(#tri3)"/>
      <polygon points="600,18 570,110 630,110" fill="url(#tri4)"/>
      <polygon points="680,22 650,110 710,110" fill="url(#tri1)"/>
      <polygon points="760,20 730,110 790,110" fill="url(#tri2)"/>
      <polygon points="840,24 810,110 870,110" fill="url(#tri3)"/>
      <polygon points="920,19 890,110 950,110" fill="url(#tri4)"/>
      <polygon points="1000,21 970,110 1030,110" fill="url(#tri1)"/>
      <polygon points="1080,23 1050,110 1110,110" fill="url(#tri2)"/>
    </g>
  </svg>

  <!-- Banner -->
  <svg class="banner d-none d-sm-block" viewBox="0 0 1200 200" preserveAspectRatio="none" aria-hidden="true">
    <defs>
      <path id="curve" d="M60,140 C360,70 840,70 1140,140" />
      <linearGradient id="bannerGradient" x1="0" y1="0" x2="1" y2="0">
        <stop offset="0%"  stop-color="#ff66a3"/>
        <stop offset="33%" stop-color="#ffd43b"/>
        <stop offset="66%" stop-color="#5eead4"/>
        <stop offset="100%" stop-color="#60a5fa"/>
      </linearGradient>
    </defs>
    <text><textPath href="#curve" startOffset="50%" text-anchor="middle">HAPPY BIRTHDAY!</textPath></text>
  </svg>

  <!-- Ceiling string lights -->
  <svg class="string-lights d-none d-sm-block" viewBox="0 0 1200 120" preserveAspectRatio="none" aria-hidden="true">
    <path d="M0,20 C300,100 900,-20 1200,60" stroke="#fff" stroke-width="2" fill="none" opacity=".35"/>
    <g>
      <circle class="bulb" cx="80" cy="38" r="6" fill="#ffe8a3"/>
      <circle class="bulb" cx="160" cy="60" r="6" fill="#ffd3e6"/>
      <circle class="bulb" cx="240" cy="75" r="6" fill="#b3e3ff"/>
      <circle class="bulb" cx="320" cy="55" r="6" fill="#ffd3e6"/>
      <circle class="bulb" cx="400" cy="34" r="6" fill="#ffe8a3"/>
      <circle class="bulb" cx="480" cy="48" r="6" fill="#b3e3ff"/>
      <circle class="bulb" cx="560" cy="70" r="6" fill="#ffd3e6"/>
      <circle class="bulb" cx="640" cy="50" r="6" fill="#ffe8a3"/>
      <circle class="bulb" cx="720" cy="28" r="6" fill="#ffd3e6"/>
      <circle class="bulb" cx="800" cy="46" r="6" fill="#b3e3ff"/>
      <circle class="bulb" cx="880" cy="72" r="6" fill="#ffd3e6"/>
      <circle class="bulb" cx="960" cy="54" r="6" fill="#ffe8a3"/>
      <circle class="bulb" cx="1040" cy="36" r="6" fill="#b3e3ff"/>
      <circle class="bulb" cx="1120" cy="64" r="6" fill="#ffd3e6"/>
    </g>
  </svg>

  <!-- FX -->
  <div class="balloons d-none d-sm-block" id="balloons" aria-hidden="true"></div>
  <div class="confetti d-none d-sm-block" id="confetti" aria-hidden="true"></div>
  <div class="sparkles d-none d-sm-block" id="sparkles" aria-hidden="true"></div>

  <!-- Main -->
  <main class="scene container-fluid">
    <div class="row justify-content-center w-100">
      <div class="col-12 col-sm-10 col-md-8 col-lg-7 mx-auto">
        <h1 class="display-6 neon">🤫 A Surprise Awaits!</h1>
        <p class="lead muted">Your friend prepared something special at home…</p>

        <!-- Lights -->
        <div id="step-lights" class="mt-4">
          <p class="prompt">It’s dark inside. Turn on the lights to reveal the surprise.</p>
          <div class="d-flex justify-content-center controls">
            <button id="btnLightsOn" class="btn btn-success btn-lg px-4">Turn on Lights 💡</button>
          </div>
          <small class="d-block mt-2 text-muted">Music will start when the lights come on.</small>
        </div>

        <!-- Cake + Candle -->
        <div class="cake-wrap hidden" id="cakeWrap" role="region" aria-label="Cake area">
          <svg class="cake-svg" viewBox="0 0 700 520" role="img" aria-label="Birthday cake with a candle">
            <defs>
              <linearGradient id="choc" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#c99376"/><stop offset="100%" stop-color="#8a5a3d"/></linearGradient>
              <radialGradient id="frost" cx="50%" cy="0%" r="100%"><stop offset="0%" stop-color="#fff7f0"/><stop offset="100%" stop-color="#ffdede"/></radialGradient>
              <linearGradient id="candleBody" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#ffffff"/><stop offset="100%" stop-color="#f0e6ff"/></linearGradient>
              <radialGradient id="flameGrad" cx="50%" cy="60%" r="60%"><stop offset="0%" stop-color="#fff"/><stop offset="45%" stop-color="#ffd27a"/><stop offset="100%" stop-color="#ff9800"/></radialGradient>
            </defs>
            <ellipse cx="350" cy="495" rx="230" ry="18" fill="#000" opacity="0.25"/>
            <g id="tiers">
              <g transform="translate(100,320)"><rect x="0" y="0" width="500" height="110" rx="18" fill="url(#choc)"/><path d="M0,30 C80,70 150,0 230,30 C310,60 380,10 500,28 L500,0 L0,0 Z" fill="url(#frost)"/></g>
              <g transform="translate(160,240)"><rect x="0" y="0" width="380" height="90" rx="16" fill="url(#choc)"/><path d="M0,26 C60,60 120,5 190,28 C260,50 320,12 380,24 L380,0 L0,0 Z" fill="url(#frost)"/></g>
              <g transform="translate(220,180)"><rect x="0" y="0" width="260" height="70" rx="14" fill="url(#choc)"/><path d="M0,22 C40,46 80,6 130,24 C180,40 220,10 260,20 L260,0 L0,0 Z" fill="url(#frost)"/></g>
            </g>
            <g id="candle" class="candle-hit" tabindex="0" role="button" aria-label="Candle" transform="translate(350,160)">
              <rect x="-8" y="-60" width="16" height="60" rx="6" fill="url(#candleBody)" stroke="#e5dbff"/>
              <rect x="-2" y="-70" width="4" height="12" rx="2" fill="#333"/>
              <ellipse id="flame" class="flame" cx="0" cy="-88" rx="9" ry="16" fill="url(#flameGrad)"/>
            </g>
          </svg>
          <div class="table-surface" aria-hidden="true"></div>

          <div id="step-candle" class="mt-2">
            <p class="prompt">Tap the candle to light it 🕯️</p>
            <button id="btnLightCandle" class="btn btn-primary btn-sm">Light Candle 🔥</button>
          </div>

          <div id="step-blow" class="hidden">
            <p class="prompt">Make a wish… then blow out the candle!</p>
            <button id="btnBlow" class="btn btn-outline-warning">💨 Blow Candle</button>
          </div>
        </div>

        <!-- Messages -->
        <div id="messages" class="mt-4 hidden">
          <div class="message-card"><p id="typeLine" class="mb-0"></p></div>
        </div>

        <!-- Gift -->
        <div id="giftStage" class="hidden">
          <div class="gift d-flex justify-content-center my-3" id="gift" role="button" aria-label="Gift">
            <div class="lid"></div>
            <div class="box"><div class="ribbon-v"></div><div class="ribbon-h"></div></div>
          </div>
          <div class="surprise text-center" id="surprise">
            <div class="mb-2">Your bonus gift: uncontrollable giggles 😆</div>
            <div class="boogie" aria-hidden="true">🕺</div>
            <p class="mt-3" id="joke"></p>
          </div>
        </div>

        <div class="mt-4"><button id="btnReplay" class="btn btn-outline-light btn-sm hidden">↻ Replay</button></div>
      </div>
    </div>
  </main>

  <!-- Sticky step-by-step guide -->
  <div class="guide" role="status" aria-live="polite">
    <span class="dot" aria-hidden="true"></span>
    <strong id="guideStep">Step 1/5:</strong>
    <span id="guideText">Press the big round button to open the door.</span>
    <span id="liveGuide"></span>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const body = document.body;
  const music = document.getElementById('music');

  const doorsLayer = document.getElementById('doorsLayer');
  const btnDoorKnob = document.getElementById('btnDoorKnob');
  const doorLabel = doorsLayer.querySelector('.door-label');

  const stepLights = document.getElementById('step-lights');
  const btnLightsOn = document.getElementById('btnLightsOn');

  const cakeWrap = document.getElementById('cakeWrap');
  const stepCandle = document.getElementById('step-candle');
  const btnLightCandle = document.getElementById('btnLightCandle');
  const stepBlow = document.getElementById('step-blow');
  const flame = document.getElementById('flame');
  const btnBlow = document.getElementById('btnBlow');

  const balloonsLayer = document.getElementById('balloons');
  const confettiLayer = document.getElementById('confetti');
  const sparklesLayer = document.getElementById('sparkles');

  const messages = document.getElementById('messages');
  const typeLine = document.getElementById('typeLine');

  const giftStage = document.getElementById('giftStage');
  const gift = document.getElementById('gift');
  const surprise = document.getElementById('surprise');
  const jokeP = document.getElementById('joke');
  const btnReplay = document.getElementById('btnReplay');

  /* Guide bar */
  const guideBar = document.querySelector('.guide');
  const guideStep = document.getElementById('guideStep');
  const guideText = document.getElementById('guideText');
  const liveGuide = document.getElementById('liveGuide');
  function setGuide(step, text){
    guideStep.textContent = `Step ${step}/5:`;
    guideText.textContent = text;
    liveGuide.textContent = ` ${guideStep.textContent} ${guideText.textContent}`; // SR update
  }

  function show(el){ el.classList.remove('hidden'); }
  function hide(el){ el.classList.add('hidden'); }

  /* Typewriter */
  const TYPE_SPEED = 40, LINE_PAUSE = 1400;
  function typeText(lines, cb){
    let i=0, j=0, current=''; typeLine.textContent='';
    function nextLine(){
      if(i>=lines.length){ cb && cb(); return; }
      current = lines[i]; j=0; typeLine.textContent='';
      const iv = setInterval(()=>{
        typeLine.textContent = current.slice(0, ++j);
        if(j>=current.length){ clearInterval(iv); setTimeout(()=>{ i++; nextLine(); }, LINE_PAUSE); }
      }, TYPE_SPEED);
    }
    nextLine();
  }

  /* Balloons */
  function makeBalloonsSVG(){
    if(!balloonsLayer) return;
    const palettes = [
      {light:'#ffd2e1', mid:'#ff7aa6', dark:'#d84c7a'},
      {light:'#d6ebff', mid:'#74b3ff', dark:'#2a7bd9'},
      {light:'#d7ffd9', mid:'#6fe07d', dark:'#2f9e44'},
      {light:'#fff5cc', mid:'#ffd34d', dark:'#c99700'}
    ];
    const count = 20;
    balloonsLayer.innerHTML=''; balloonsLayer.style.zIndex = 1;
    for(let i=0; i<count; i++){
      const p = palettes[i%palettes.length];
      const wrap = document.createElement('div');
      wrap.className = 'balloon-wrap';
      let leftVW = Math.random()*100;
      if(leftVW > 38 && leftVW < 62) leftVW = (Math.random()<.5)? (Math.random()*38) : (62 + Math.random()*38);
      wrap.style.left = leftVW + 'vw';
      wrap.style.setProperty('--drift', (Math.random()*80-40) + 'px');
      wrap.style.setProperty('--twist', (Math.random()*12-6) + 'deg');
      wrap.style.animation = `floatUp ${7 + Math.random()*6}s linear ${Math.random()*3}s infinite`;

      const gradId = `g${i}-${Date.now()}`;
      wrap.innerHTML = `
        <svg class="balloon-svg" viewBox="0 0 90 120" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs><radialGradient id="${gradId}" cx="50%" cy="35%" r="55%">
            <stop offset="0%" stop-color="${p.light}"/><stop offset="60%" stop-color="${p.mid}"/><stop offset="100%" stop-color="${p.dark}"/>
          </radialGradient></defs>
          <path d="M45 10c-20 0-35 14-35 33 0 18 11 29 22 38 3 2 1 7-1 10l4 6 20 0 4-6c-2-3-4-8-1-10 11-9 22-20 22-38 0-19-15-33-34-33z" fill="url(#${gradId})"/>
          <ellipse cx="35" cy="28" rx="7" ry="11" fill="#ffffff" opacity="0.5"/>
          <path d="M45 92 L45 106" stroke="#666" stroke-width="2"/>
        </svg>`;
      const stringEl = document.createElement('div'); stringEl.className = 'balloon-string'; wrap.appendChild(stringEl);
      balloonsLayer.appendChild(wrap);
    }
  }

  function burstConfetti(n=160){
    if(!confettiLayer) return;
    confettiLayer.innerHTML='';
    const colors=['#ff4d8d','#ffd43b','#4dabf7','#51cf66','#ffffff'];
    for(let i=0;i<n;i++){
      const s = document.createElement('span');
      s.style.left = Math.random()*100 + 'vw';
      s.style.top = - (Math.random()*40) + 'vh';
      const w = 6 + Math.random()*8, h = 8 + Math.random()*12;
      s.style.width = w + 'px'; s.style.height = h + 'px';
      s.style.background = colors[i%colors.length];
      s.style.animation = `fall ${4 + Math.random()*3}s linear ${Math.random()*1.5}s forwards`;
      confettiLayer.appendChild(s);
    }
    setTimeout(()=> confettiLayer.innerHTML='', 9000);
  }

  function startSparkles(){
    if(!sparklesLayer) return;
    sparklesLayer.innerHTML='';
    for(let i=0;i<50;i++){
      const sp = document.createElement('span');
      sp.style.left = Math.random()*100 + 'vw';
      sp.style.bottom = Math.random()*30 + 'vh';
      sp.style.animationDelay = (Math.random()*2.6) + 's';
      sparklesLayer.appendChild(sp);
    }
  }

  function playMusicAuto(){
    music.loop = true; music.volume = 0.7;
    const p = music.play(); if(p && p.catch){ p.catch(()=>{}); }
  }

  /* FLOW */
  setGuide(1, 'Press the big round button to open the door.');

  // Open door
  btnDoorKnob.addEventListener('click', ()=>{
    body.classList.add('open');
    btnDoorKnob.style.display = 'none';
    doorLabel.style.display = 'none';
    setTimeout(()=>{ doorsLayer.style.display = 'none'; }, 1150);
    setGuide(2, 'Turn on the lights to reveal the surprise. Tap the green button.');
    window.scrollTo({top:0, behavior:'smooth'});
  });

  // Turn on lights
  btnLightsOn.addEventListener('click', ()=>{
    body.classList.add('lights-on');
    hide(stepLights);
    show(cakeWrap);
    setGuide(3, 'Tap the candle to light it. Or press “Light Candle”.');
    playMusicAuto();
    if(getComputedStyle(balloonsLayer || document.body).display !== 'none') makeBalloonsSVG();
    if(getComputedStyle(sparklesLayer || document.body).display !== 'none') startSparkles();
    if(getComputedStyle(confettiLayer || document.body).display !== 'none') burstConfetti(200);
    cakeWrap.scrollIntoView({behavior:'smooth', block:'center'});
  });

  // Candle
  function lightCandle(){
    flame.style.opacity = 1; flame.classList.add('flicker');
    hide(stepCandle); show(stepBlow);
    setGuide(4, 'Make a wish… then blow out the candle. Tap “Blow Candle”.');
  }
  document.getElementById('candle').addEventListener('click', lightCandle);
  document.getElementById('candle').addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); lightCandle(); }});
  btnLightCandle.addEventListener('click', lightCandle);

  // Blow
  function blowOut(){
    flame.style.opacity = 0; flame.classList.remove('flicker');
    hide(stepBlow);
    const lines = [
      '🎉 Happy Birthday!',
       "Send from Khorshed Alom",      
        "Count your life by smiles, not tears",      
        "Count your age by friends, not years",      
        "Beloved Respected APU", 
        "Today is your birthday",
        "Wish you happy returns of the day",
        "শুভ পয়দা দিবস",
        "Happy Downloading... Day",
        "Lots Of love",
    ];
    show(messages);
    setGuide(5, 'Enjoy the messages, then tap the gift box to open it.');
    typeText(lines, ()=>{
      show(giftStage);
      const giftEl = document.querySelector('.gift'); if(giftEl){ giftEl.style.opacity = 1; giftEl.style.transform='none'; }
      burstConfetti(160);
    });
  }
  btnBlow.addEventListener('click', blowOut);

  // Gift
  const jokes = [
    'I bought you a candle. It was a little wick-spensive. 🕯️',
    'Aging is like software updates: mostly security patches. 😅',
    'Why did the cake go to therapy? Too many layers. 🍰',
    'Birthdays are good for you. The more you have, the longer you live. 📈',
    'You don’t look a day over fabulous. ✨'
  ];
  if(gift) gift.addEventListener('click', ()=>{
    gift.classList.add('open'); surprise.style.display='block';
    jokeP.textContent = jokes[Math.floor(Math.random()*jokes.length)];
    burstConfetti(200); 
    guideBar.classList.add('hidden'); // guide no longer needed
    document.getElementById('btnReplay').classList.remove('hidden');
  });

  // Replay
  btnReplay.addEventListener('click', ()=>{
    music.pause(); music.currentTime=0;
    body.className='';
    doorsLayer.style.display='';
    btnDoorKnob.style.display='flex'; doorLabel.style.display='block';
    [cakeWrap, messages, giftStage, btnReplay].forEach(el=>el.classList.add('hidden'));
    stepLights.classList.remove('hidden');
    typeLine.textContent='';
    if(balloonsLayer) balloonsLayer.innerHTML=''; if(confettiLayer) confettiLayer.innerHTML=''; if(sparklesLayer) sparklesLayer.innerHTML='';
    flame.style.opacity=0; flame.classList.remove('flicker');
    surprise.style.display='none'; gift.classList.remove('open');
    const giftDom = document.querySelector('.gift'); if(giftDom){ giftDom.style.opacity=0; giftDom.style.transform='translateY(10px)'; }
    guideBar.classList.remove('hidden');
    setGuide(1, 'Press the big round button to open the door.');
    window.scrollTo({top:0, behavior:'smooth'});
  });

  // Keyboard blow
  document.addEventListener('keydown', (e)=>{
    if(!stepBlow.classList.contains('hidden') && (e.key===' ' || e.key==='Enter')){ e.preventDefault(); blowOut(); }
  });
</script>
</body>
</html>
